<!DOCTYPE html>
<html>
<head lang="en">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
    <meta charset="UTF-8">
    <title>DDelivery</title>
    <style>
        html,body,#widget {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        #widget {
            padding: 0px;
            position: relative;
        }
        #widget iframe {
            width: 100% !important;
            height: 100% !important;
            top: 0;
            left: 0;
        }

        .header,.content {
            box-sizing: border-box;
            padding: 10px;
            position: relative;
        }

        .header {
            height: 30px;
        }
        .content {
            height: calc(100vh - 30px);
        }
    </style>
</head>
<body>
<div class="content">

    <div id="widget"></div>

</div>

<!-- DDeliveryWidget -->
<script type="text/javascript">
	window['DDeliveryWidget'] = (function () {

		var ENV_PROD = 'prod', ENV_DEV = 'dev',
			error = true, errorMessage = '',
			path = {
				map: '',
				index: ''
			},
			deliveryIframe = document.createElement('iframe'),
			deliveryMap = document.createElement('iframe'),
			params = {
				id: 0,
				name: 'ddelivery-widget',
				env: ENV_PROD,
				url: {
					dev: 'http://sdk2.dev.ddelivery.ru/api/v1/integration/module.json',
					prod: 'https://sdk.ddelivery.ru/api/v1/integration/module.json'
				},
				width: 400,
				height: 500,
				products: []

			}, element, sendParams = ['id', 'products'];

		var run = function () {
				var iframe = createIframe();
				element.appendChild(iframe);
			},

			setTokenValue = function (token) {
				window['localStorage']['dd_sdk_module.ttl_token'] = token;
			},

			getTokenValue = function () {
				return window['localStorage']['dd_sdk_module.ttl_token'] || '';
			},

			serialize = function (obj, prefix) {
				var str = [], p;
				for (p in obj) {
					if (obj.hasOwnProperty(p)) {
						var k = prefix ? prefix + "[" + p + "]" : p, v = obj[p];
						str.push((v !== null && typeof v === "object") ?
							serialize(v, k) :
							encodeURIComponent(k) + "=" + encodeURIComponent(v));
					}
				}
				return str.join("&");
			},
			getUrl = function () {

				if(path.index != ''){
					return path.index;
				}

				var url = params['url'][params['env']];
				var query = {};

				for (var i = 0; i < sendParams.length; i++) {
					if (typeof params[sendParams[i]] != 'undefined') {
						query[sendParams[i]] = params[sendParams[i]];
					}
				}

				query['token'] = getTokenValue();
				url += '?' + serialize(query);

				return url;
			},


			createMapIframe = function(data){
				var doc = document.documentElement;
				var left = (window.pageXOffset || doc.scrollLeft) - (doc.clientLeft || 0);
				var top = (window.pageYOffset || doc.scrollTop) - (doc.clientTop || 0);
				var height = "innerHeight" in window ? window.innerHeight : document.documentElement.offsetHeight;

				path.map = data.location;
				deliveryMap.style.width = '100%';
				deliveryMap.style.height = height + 'px'; //'100%';
				//alert( window.innerHeight );
				//deliveryMap.style.position = 'fixed';
				deliveryMap.style.overflowX = 'hidden';
				deliveryMap.style.display = "block";
				deliveryMap.scrolling = 'no';
				deliveryMap.frameBorder = 0;
				deliveryMap.style.borderWidth = 0;
				deliveryMap.style.position = "absolute";
				//deliveryMap.style.position = 'fixed';
				deliveryMap.style.top = top + "px";
				deliveryMap.style.left = left + "px";
				deliveryMap.style.background = "transparent";
				deliveryMap.style.zIndex = "10000";
				deliveryMap.src = path.map;
				document.body.appendChild(deliveryMap);
			},

			createIframe = function () {
				element.innerHTML = '';
				deliveryIframe.setAttribute("name", params['name']);
				deliveryIframe.style.width = params['width'] + 'px';
				deliveryIframe.style.height = params['height'] + 'px';
				deliveryIframe.style.overflow = 'hidden';
				deliveryIframe.scrolling = 'no';
				deliveryIframe.frameBorder = 0;
				deliveryIframe.style.borderWidth = 0;
				deliveryIframe.style.position = "absolute";
				deliveryIframe.style.background = "transparent";
				deliveryIframe.src = getUrl();

				if (typeof (window.addEventListener) != 'undefined') { // ALL kind
					window.addEventListener("message", iframeEventsHandler, false);
				} else { // IE
					window.attachEvent("onmessage", iframeEventsHandler);
				}

				return deliveryIframe;

			},

			configure = function (defaultParams, input) {
				for (var item in input) {
					if (typeof defaultParams[item] != 'undefined') {
						defaultParams[item] = input[item];
					}
				}
				return defaultParams;
			},

			iframeEventsHandler = function (event) {
				var data;
				if (typeof event['data'] == 'undefined') {
					return;
				}
				data = event['data'];
				if (typeof data['indexOf'] == 'undefined') {
					return;
				}

				var pos = data.indexOf('"action"');
				if (pos == -1) {
					return;
				}
				data = JSON.parse(data);
				if (typeof data['action'] != 'undefined' && typeof callbacks[data['action']] == 'function') {
					if(params.env == ENV_DEV){
						console.log("event name: " + data['action']);
						console.log("params");
						console.log(data['data']);
					}
					callbacks[data['action']](data['data']);
				}

			},

			callbacks = {

				// map point selection
				select: function (data) {

					deliveryMap.style.display = 'none';
					path.index = data['index'];
					deliveryIframe.src = path.index;
					deliveryIframe.focus();

				},

				token: function (data) {
					setTokenValue(data['token']);
				},

				update: function(data){
					if(typeof data['error'] != 'undefined'){
						error = true;
						errorMessage = data['error_message']
					}else {
						error = false;
						errorMessage = "";
						this.change(data);
					}
				},

				change: function (data) {
					if(params.env == ENV_DEV) {
						//console.log(data);
					}
				},

				price: function (data) {
					if(params.env == ENV_DEV) {
						//console.log(data);
					}
				},

				close: function (data) {
					deliveryMap.style.display = 'none';
				},

				resize: function (data) {
					deliveryIframe.style.height = data.height + 'px';
				},

				// РР·РјРµРЅРµРЅРёСЏ С†РµРЅС‹
				src: function (data) {
					path.map = data['map'] || '';
					path.index = data['index'] || '';
				},

				map: createMapIframe

			};

		return {

			ENV_DEV: ENV_DEV,
			ENV_PROD: ENV_PROD,

			validate: function () {
				return !error;
			},

			getErrorMsg:function(){
				return errorMessage;
			},

			init: function (id, userParams, userCallbacks) {
				element = document.getElementById(id);

				if (userCallbacks != null) {
					callbacks = configure(callbacks, userCallbacks);
				}

				if (userParams != null) {
					params = configure(params, userParams);
				}

				run();
			}
		}
	})();
</script>


<!-- App -->
<script type="text/javascript">

	/**
     * This app is for shiwing inside WebView. Tasks are:
     * 1. Show widget to select delivery method and address
     * 2. Pass info about selected method and address back to parent app
     *    with going for specified url with params
	 */

	var isicStoreId = 71878;
	var nativeAppBridgeKey = '__NATIVE_APP_BRIDGE';
	var isicProductsUrl = 'https://stage.alol.io/rest/2.0/isic-cards-list';

	var isicApiKey = 'd9a0b7073a2ff803c42beda4e1cb66cd';
	var isicActivationLink = `https://sdk.ddelivery.ru/api/v1/integration/d9a0b7073a2ff803c42beda4e1cb66cd/link.json`; // id: 71878
	var isicDeactivationLink = `https://sdk.ddelivery.ru/api/v1/integration/d9a0b7073a2ff803c42beda4e1cb66cd/reset.json`;
	var isicSettingsLink = `https://sdk.ddelivery.ru/api/v1/integration/d9a0b7073a2ff803c42beda4e1cb66cd/pam.json`;

	var DDeliveryProductDefaults = {
		id: 0,
		name: 'Карта ISIC',
		price: 600,
		width: 33,
		height: 20,
		length: 1,
		weight: 0.1,
		quantity: 1,
		sku: 'SKU PRODUCT'
	};

	function formatResult (data) {
		return data
	}

	function submit (data) {
		try {
//			window[nativeAppBridgeKey](formatResult(data));
			window.webkit.messageHandlers.buttonClicked.postMessage(formatResult(data));
            return true
		} catch (e) {
			console.warn(e)
			return false
		}
	}

    function initDDeliveryWidget (orderedProducts) {
		console.warn('isicProducts',orderedProducts);
		window.localStorage.clear();

		DDeliveryWidget.init('widget', {
			products: orderedProducts,
			id: isicStoreId,
			env: DDeliveryWidget.ENV_PROD
		}, {
			price: function (data) {
				console.log('price');
				console.log(data);
			},
			change: function (data) {
				console.log('change',data);
				submit(data)
			}
		});
    }

	function startDdeliveryOrderProcedure (selectedProductIds) {
		if (selectedProductIds == null) selectedProductIds = [];

		fetch(isicProductsUrl)
            .then(function (res) {
                var isicProducts = res && res.data && res.data.items || [];

				var orderedProducts = isicProducts
					.filter(function (el) { return selectedProductIds.includes(el.id) })
					.map(function (el) { return Object.assign({},DDeliveryProductDefaults,el)});

                initDDeliveryWidget(orderedProducts);
            });
    }

    function TEST_startDdeliveryOrderProcedure () {
		startDdeliveryOrderProcedure([1])
    }

	window.startDdeliveryOrderProcedure = startDdeliveryOrderProcedure;

</script>

</body>